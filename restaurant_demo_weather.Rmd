---
title: "dataclean"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

Load the data

```{r}
business<-readRDS("yelp_academic_dataset_business.rds")
checkin<-readRDS("yelp_academic_dataset_checkin.rds")
user<-read.csv("user_simplified.csv")
review<-readRDS("yelp_academic_dataset_review.rds")
tip<-readRDS("yelp_academic_dataset_tip.rds")
```

clean the business data:
1.Choose the resaurant with review counts more than 50:
```{r}
library(dplyr)
business_simple<-business%>%filter(grepl("Restautrant|Food|Breakfast|Bars|food|Burgers|Brunch|Sandwiches|Pubs|Chinese|Italian|American|Pizza|Coffee|Tea|Fast Food|Asian|Fusion|Lounges|Cafes|Irish|Gluten|Salad|Diners|Seafood|Bakeries|Desserts|Japanese|Ice Cream & Frozen Yogurt|Tapas/Small Plates|Mediterranean|Wine Bars|Vegetarian|Portuguese|German|Delis|Chicken Wings|Hot Dogs|Polish|Greek|Sushi Bars|Indian|Mexican|Bagels|Donuts|Tapas Bars|Cocktail Bars|Ethnic Food|Middle Eastern|Steakhouses|Cafeteria|Candy Stores|Korean|Chocolatiers & Shops|Cheese Shops|Vietnamese|Thai|Tea Rooms|Latin American|Creperies|French|Taiwanese|Buffets|Cajun/Creole|Soul Food|Juice Bars & Smoothies|Fondue|Ethiopian|Persian/Iranian|Popcorn Shops|Spanish|Cheesesteaks|Fish & Chips|British|Kosher|Armenian|Cupcakes|Vegan|Hawaiian|Cuban|Gastropubs|Russian|Pretzels|Fruits & Veggies|Gelato|Halal|Dim Sum|Filipino|Pasta Shops|Mongolian|Colombian|Cantonese|Street Vendors|Belgian|Cambodian|Hungarian|Szechuan|Bubble Tea|Laotian|African|Beer Bar|Himalayan/Nepalese|Moroccan|Falafel|Indonesian|Turkish|Afghan|Food Stands|Modern European|Irish Pub|Brazilian|Food Court|Malaysian|Coffeeshops|Hot Pot|Burmese|Macarons|Ramen|Empanadas|Bistros|Teppanyaki|Brasseries|Singaporean|Champagne Bars|Scandinavian|Canadian|Poutineries|Haitian|Arabian|Austrian|Czech|Slovakian|Bangladeshi|Egyptian|Dominican|Scottish|Patisserie/Cake Shop|Pub Food|Puerto Rican|Australian|Ukrainian|Sri Lankan|Beer Garden|International|Beer Gardens|Serbo Croatian|Kebab|Alsatian|Oriental|Shanghainese|Venezuelan|Bavarian|Iberian|Curry Sausage|Rhinelandian|Beer Hall|Eastern European|Wok|Trinidadian|Swiss Food|Pita",categories))%>%
  filter(!grepl("Grocery|Hotels",categories) &
           !grepl("Supermarket|Pharmacy",name))%>%
  filter(review_count>50)
```

2. Choose the city: select 6 states in USA ( PA,NC,IL,AZ,NV,WI) 
```{r}
PA<-business_simple%>%filter(state%in%c("PA"))%>%group_by(city)%>%summarize(n=n())%>%filter(n>100)
##only Pittsburgh
NC<-business_simple%>%filter(state%in%c("NC"))%>%group_by(city)%>%summarize(n=n())%>%filter(n>100)
##only Charlotte
IL<-business_simple%>%filter(state%in%c("IL"))%>%group_by(city)%>%summarize(n=n())
## Champaign Urbana have restautant less than 100, this may becuase the city is small
AZ<-business_simple%>%filter(state%in%c("AZ"))%>%group_by(city)%>%summarize(n=n())%>%filter(n>100)
## Phoenix Scottsdale Tempe Mesa Chandler Gilbert Glendale
NV<-business_simple%>%filter(state%in%c("NV"))%>%group_by(city)%>%summarize(n=n())%>%filter(n>100)
## Las Vegas Henderson
WI<-business_simple%>%filter(state%in%c("WI"))%>%group_by(city)%>%summarize(n=n())%>%filter(n>100)
## Madison

business_simple<-business_simple%>%
  filter(city%in%c("Pittsburgh","Charlotte","Urbana","Champaign","Phoenix", "Scottsdale","Tempe","Mesa", "Chandler","Gilbert","Glendale", "Las Vegas","Henderson", "Madison"))
  
business_simple%>%group_by(city)%>%summarize(n())
```

3. select variables
```{r}
## extract the zip code from full address
business_simple$zip <- lapply(strsplit(as.character(business_simple$full_address), "\\,"), "[", 2)
business_simple$zip<-as.numeric(gsub("[[:alpha:]]", "", business_simple$zip))

## select variables
business_clean<-business_simple %>% select(business_id,categories,city,review_count,name,neighborhoods,state,stars,`attributes.Take-out`,`attributes.Noise Level`,`attributes.Takes Reservations`,`attributes.Outdoor Seating`,`attributes.Alcohol`,`attributes.Waiter Service`,`attributes.Accepts Credit Cards`,`attributes.Good for Kids`,`attributes.Good For Groups`,`attributes.Price Range`,`attributes.Wi-Fi`,`attributes.Good For.dessert`,`attributes.Good For.latenight`,`attributes.Good For.lunch`,`attributes.Good For.dinner`,`attributes.Good For.brunch`,`attributes.Good For.breakfast`,`attributes.Parking.garage`,`attributes.Parking.street`,`attributes.Parking.validated`,`attributes.Parking.lot`,`attributes.Parking.valet`,zip)%>%
  filter(!is.na(`attributes.Take-out`)&
           !is.na(`attributes.Noise Level`)&
           !is.na(`attributes.Takes Reservations`)&
           !is.na(`attributes.Outdoor Seating`)&
           !is.na(`attributes.Alcohol`)&
           !is.na(`attributes.Waiter Service`)&
           !is.na(`attributes.Accepts Credit Cards`)&
           !is.na(`attributes.Good for Kids`)&
           !is.na(`attributes.Good For Groups`)&
           !is.na(`attributes.Price Range`)&
           !is.na(`attributes.Wi-Fi`)&
           !is.na(`attributes.Good For.dessert`)&
           !is.na(`attributes.Good For.latenight`)&
           !is.na(`attributes.Good For.lunch`)&
           !is.na(`attributes.Good For.dinner`)&
           !is.na(`attributes.Good For.brunch`)&
           !is.na(`attributes.Good For.breakfast`)&
           !is.na(`attributes.Parking.garage`)&
           !is.na(`attributes.Parking.street`)&
           !is.na(`attributes.Parking.validated`)&
           !is.na(`attributes.Parking.lot`)&
           !is.na(`attributes.Parking.valet`)&
           !is.na(zip))

business_clean$`attributes.Take-out`<-as.numeric(business_clean$`attributes.Take-out`)
business_clean$`attributes.Takes Reservations`<-as.numeric(business_clean$`attributes.Takes Reservations`)
business_clean$`attributes.Outdoor Seating`<-as.numeric(business_clean$`attributes.Outdoor Seating`)
business_clean$`attributes.Waiter Service`<-as.numeric(business_clean$`attributes.Waiter Service`)
business_clean$`attributes.Accepts Credit Cards`<-as.numeric(business_clean$`attributes.Accepts Credit Cards`)
business_clean$`attributes.Good for Kids`<-as.numeric(business_clean$`attributes.Good for Kids`)
business_clean$`attributes.Good For Groups`<-as.numeric(business_clean$`attributes.Good For Groups`)
business_clean$`attributes.Good For.dessert`<-as.numeric(business_clean$`attributes.Good For.dessert`)
business_clean$`attributes.Good For.latenight`<-as.numeric(business_clean$`attributes.Good For.latenight`)
business_clean$`attributes.Good For.lunch`<-as.numeric(business_clean$`attributes.Good For.lunch`)
business_clean$`attributes.Good For.dinner`<-as.numeric(business_clean$`attributes.Good For.dinner`)
business_clean$`attributes.Good For.brunch`<-as.numeric(business_clean$`attributes.Good For.brunch`)
business_clean$`attributes.Good For.breakfast`<-as.numeric(business_clean$`attributes.Good For.breakfast`)
business_clean<-business_clean%>%
  mutate(parking=ifelse(`attributes.Parking.garage`==TRUE,1,
                  ifelse(`attributes.Parking.validated`==TRUE,1,
                  ifelse(`attributes.Parking.lot`==TRUE,1,
                  ifelse(`attributes.Parking.valet`==TRUE,1,
                  ifelse(`attributes.Parking.street`==TRUE,2,0))))))%>%
  select(business_id:`attributes.Good For.breakfast`,parking,zip)%>%
  mutate(`attributes.Noise Level`=ifelse(`attributes.Noise Level`=="quiet",0,
               ifelse(`attributes.Noise Level`=="average",1,
              ifelse(`attributes.Noise Level`=="loud",2,3
                ))))%>%
  mutate(`attributes.Alcohol`= ifelse(`attributes.Alcohol`=="none",0,1),
                    `attributes.Wi-Fi`= ifelse(`attributes.Wi-Fi`=="no",0,
                                        ifelse(`attributes.Wi-Fi`=="free",1,2)))


```

clean tip data:

```{r}
tip_clean<-tip%>%select(business_id,user_id,date,text)
```
clean user data:

```{r}
user_clean<-user%>%select(user_id,review_count)
colnames(user_clean)[2]<-"reviewcount_individual"
```

clean review data:

```{r}
review_clean<-review%>%select(business_id,user_id,date,stars)
review_clean_txt<-review%>%select(business_id,user_id,date,text,stars)
colnames(review_clean)[4]<-"star_individual"
colnames(review_clean_txt)[5]<-"star_individual"
```

combine restaurant data
```{r}
business_review<-business_clean%>%
  left_join(review_clean,by="business_id")
restaurant<-left_join(business_review,user_clean,by="user_id")
```


add in zipcode level demographic data
```{r}
library(readr)
population_zip<-read_csv("population_zipcode_2009-2014.csv")
income_zip<-read_csv("income_zipcode_2009-2014.csv")
education_zip<-read_csv("education_zipcode_2009-2014.csv")
age_zip<-read_csv("age_zipcode_2009-2014.csv")
race_zip<-read_csv("race_zipcode_2009-2014.csv")
```

demographic data clean
```{r}
##population of each zip code
population_zipdata<-population_zip%>%select(GEO.id2,HD01_VD01)
colnames(population_zipdata)<-c("zip","population_zip")
population_zipdata<-population_zipdata[-1,]

##median income of each zip code
income_zipdata<-income_zip%>%select(GEO.id2,HD01_VD02)
colnames(income_zipdata)<-c("zip","income_zip")
income_zipdata<-income_zipdata[-1,]

##bachelors degree of each zip code
education_zipdata<-education_zip%>%select(GEO.id2,HD01_VD06)
colnames(education_zipdata)<-c("zip","bachelor")
education_zipdata<-education_zipdata[-1,]

##median age of each zip code
age_zipdata<-age_zip%>%select(GEO.id2,HD01_VD02)
colnames(age_zipdata)<-c("zip","age_zip")
age_zipdata<-age_zipdata[-1,]

##race of each zip code
race_zipdata<-race_zip%>%select(GEO.id2,HD01_VD02,HD01_VD03,HD01_VD04,HD01_VD05,HD01_VD06,HD01_VD07)
colnames(race_zipdata)<-c("zip","white","Black or African American","American Indian and Alaska Native","Asian","Native Hawaiian and Other Pacific Islander","other")
race_zipdata<-race_zipdata[-1,]

##combine restaurant and zipcode scale demographic data
restaurant$zip <- as.factor(as.character(restaurant$zip ))
combine<-left_join(restaurant,population_zipdata,by="zip")
combine<-left_join(combine,income_zipdata,by="zip")
combine<-left_join(combine,education_zipdata,by="zip")
combine<-left_join(combine,age_zipdata,by="zip")
combine<-left_join(combine,race_zipdata,by="zip")
combine$population_zip <- as.numeric(as.character(combine$population_zip  ))
combine$income_zip <- as.numeric(as.character(combine$income_zip  ))
combine$bachelor <- as.numeric(as.character(combine$bachelor ))
combine$age_zip <- as.numeric(as.character(combine$age_zip ))
combine<-combine%>%mutate(education_zip=bachelor/population_zip)
combine<-combine%>%filter(!is.na(population_zip)&!is.na(income_zip)&!is.na(education_zip)&!is.na(age_zip))%>%select(-bachelor)
data.frame(n.na=sapply(combine, function(x)sum(is.na(x)))) 
```


combine weather data:
```{r}
## add in station name
combine_weather<-combine%>%
  mutate(STATION=ifelse(city%in%c("Urbana","Champaign"),"GHCND:USC00118740 ",
                ifelse(city%in%c("Phoenix","Scottsdale","Tempe","Mesa","Chandler","Gilbert","Glendale"), "GHCND:USW00023183",
                       ifelse(city%in%c("Las Vegas","Henderson"),"GHCND:USW00023169",
                              ifelse(city%in%c("Pittsburgh"),"GHCND:USW00094823",
                                     ifelse(city%in%c("Madison"),"GHCND:USW00014837","GHCND:USW00013881"))))))

library(data.table)
weather<-fread("weather_clean.csv")
weather$date<-as.Date(weather$date)
combine_weather$date<-as.Date(combine_weather$date)
combine_weather<-left_join(combine_weather,weather,by=c("STATION","date"))
restaurant_demo_weather<- data.frame(lapply(combine_weather, as.character), stringsAsFactors=FALSE)
write.csv(restaurant_demo_weather,file="combine.csv")

```
