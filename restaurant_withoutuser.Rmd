---
title: "dataclean"
output: html_document
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

Load the data

```{r}
business<-readRDS("yelp_academic_dataset_business.rds")
checkin<-readRDS("yelp_academic_dataset_checkin.rds")
user<-read.csv("user_simplified.csv")
review<-readRDS("yelp_academic_dataset_review.rds")
tip<-readRDS("yelp_academic_dataset_tip.rds")
```

clean the business data:
1.Choose the resaurant with review counts more than 50:
```{r}
library(dplyr)
business_simple<-business%>%filter(grepl("Restautrant|Food|Breakfast|Bars|food|Burgers|Brunch|Sandwiches|Pubs|Chinese|Italian|American|Pizza|Coffee|Tea|Fast Food|Asian|Fusion|Lounges|Cafes|Irish|Gluten|Salad|Diners|Seafood|Bakeries|Desserts|Japanese|Ice Cream & Frozen Yogurt|Tapas/Small Plates|Mediterranean|Wine Bars|Vegetarian|Portuguese|German|Delis|Chicken Wings|Hot Dogs|Polish|Greek|Sushi Bars|Indian|Mexican|Bagels|Donuts|Tapas Bars|Cocktail Bars|Ethnic Food|Middle Eastern|Steakhouses|Cafeteria|Candy Stores|Korean|Chocolatiers & Shops|Cheese Shops|Vietnamese|Thai|Tea Rooms|Latin American|Creperies|French|Taiwanese|Buffets|Cajun/Creole|Soul Food|Juice Bars & Smoothies|Fondue|Ethiopian|Persian/Iranian|Popcorn Shops|Spanish|Cheesesteaks|Fish & Chips|British|Kosher|Armenian|Cupcakes|Vegan|Hawaiian|Cuban|Gastropubs|Russian|Pretzels|Fruits & Veggies|Gelato|Halal|Dim Sum|Filipino|Pasta Shops|Mongolian|Colombian|Cantonese|Street Vendors|Belgian|Cambodian|Hungarian|Szechuan|Bubble Tea|Laotian|African|Beer Bar|Himalayan/Nepalese|Moroccan|Falafel|Indonesian|Turkish|Afghan|Food Stands|Modern European|Irish Pub|Brazilian|Food Court|Malaysian|Coffeeshops|Hot Pot|Burmese|Macarons|Ramen|Empanadas|Bistros|Teppanyaki|Brasseries|Singaporean|Champagne Bars|Scandinavian|Canadian|Poutineries|Haitian|Arabian|Austrian|Czech|Slovakian|Bangladeshi|Egyptian|Dominican|Scottish|Patisserie/Cake Shop|Pub Food|Puerto Rican|Australian|Ukrainian|Sri Lankan|Beer Garden|International|Beer Gardens|Serbo Croatian|Kebab|Alsatian|Oriental|Shanghainese|Venezuelan|Bavarian|Iberian|Curry Sausage|Rhinelandian|Beer Hall|Eastern European|Wok|Trinidadian|Swiss Food|Pita",categories))%>%
  filter(!grepl("Grocery|Hotels",categories) &
           !grepl("Supermarket|Pharmacy",name))
```

2. Choose the city: select 6 states in USA ( PA,NC,IL,AZ,NV,WI) 
```{r}
PA<-business_simple%>%filter(state%in%c("PA"))%>%group_by(city)%>%summarize(n=n())%>%filter(n>100)
##only Pittsburgh
NC<-business_simple%>%filter(state%in%c("NC"))%>%group_by(city)%>%summarize(n=n())%>%filter(n>100)
##only Charlotte
IL<-business_simple%>%filter(state%in%c("IL"))%>%group_by(city)%>%summarize(n=n())
## Champaign Urbana have restautant less than 100, this may becuase the city is small
AZ<-business_simple%>%filter(state%in%c("AZ"))%>%group_by(city)%>%summarize(n=n())%>%filter(n>100)
## Phoenix Scottsdale Tempe Mesa Chandler Gilbert Glendale
NV<-business_simple%>%filter(state%in%c("NV"))%>%group_by(city)%>%summarize(n=n())%>%filter(n>100)
## Las Vegas Henderson
WI<-business_simple%>%filter(state%in%c("WI"))%>%group_by(city)%>%summarize(n=n())%>%filter(n>100)
## Madison

business_simple<-business_simple%>%
  filter(city%in%c("Pittsburgh","Charlotte","Urbana","Champaign","Phoenix", "Scottsdale","Tempe","Mesa", "Chandler","Gilbert","Glendale", "Las Vegas","Henderson", "Madison"))
  
business_simple<-business_simple%>%mutate(city = ifelse(city=="Urbana", "Urbana_Champaign", city))%>%mutate(city = ifelse(city=="Champaign", "Urbana_Champaign", city)) 
```

3. select variables
```{r}
## extract the zip code from full address
business_simple$zip <- lapply(strsplit(as.character(business_simple$full_address), "\\,"), "[", 2)
business_simple$zip<-as.numeric(gsub("[[:alpha:]]", "", business_simple$zip))

## select variables
business_clean<-business_simple %>% select(business_id,categories,city,review_count,name,neighborhoods,state,stars,`attributes.Take-out`,`attributes.Noise Level`,`attributes.Takes Reservations`,`attributes.Outdoor Seating`,`attributes.Alcohol`,`attributes.Waiter Service`,`attributes.Accepts Credit Cards`,`attributes.Good for Kids`,`attributes.Good For Groups`,`attributes.Price Range`,`attributes.Wi-Fi`,`attributes.Good For.dessert`,`attributes.Good For.latenight`,`attributes.Good For.lunch`,`attributes.Good For.dinner`,`attributes.Good For.brunch`,`attributes.Good For.breakfast`,`attributes.Parking.garage`,`attributes.Parking.street`,`attributes.Parking.validated`,`attributes.Parking.lot`,`attributes.Parking.valet`,zip)%>%
  filter(!is.na(`attributes.Take-out`)&
           !is.na(`attributes.Noise Level`)&
           !is.na(`attributes.Takes Reservations`)&
           !is.na(`attributes.Outdoor Seating`)&
           !is.na(`attributes.Alcohol`)&
           !is.na(`attributes.Waiter Service`)&
           !is.na(`attributes.Accepts Credit Cards`)&
           !is.na(`attributes.Good for Kids`)&
           !is.na(`attributes.Good For Groups`)&
           !is.na(`attributes.Price Range`)&
           !is.na(`attributes.Wi-Fi`)&
           !is.na(`attributes.Good For.dessert`)&
           !is.na(`attributes.Good For.latenight`)&
           !is.na(`attributes.Good For.lunch`)&
           !is.na(`attributes.Good For.dinner`)&
           !is.na(`attributes.Good For.brunch`)&
           !is.na(`attributes.Good For.breakfast`)&
           !is.na(`attributes.Parking.garage`)&
           !is.na(`attributes.Parking.street`)&
           !is.na(`attributes.Parking.validated`)&
           !is.na(`attributes.Parking.lot`)&
           !is.na(`attributes.Parking.valet`)&
           !is.na(zip))

business_clean$takeout<-as.numeric(business_clean$`attributes.Take-out`)
business_clean$reservation<-as.numeric(business_clean$`attributes.Takes Reservations`)
business_clean$outdoorseating<-as.numeric(business_clean$`attributes.Outdoor Seating`)
business_clean$waiterservice<-as.numeric(business_clean$`attributes.Waiter Service`)
business_clean$creditcards<-as.numeric(business_clean$`attributes.Accepts Credit Cards`)
business_clean$goodforkids<-as.numeric(business_clean$`attributes.Good for Kids`)
business_clean$goodforgroups<-as.numeric(business_clean$`attributes.Good For Groups`)
business_clean$goodfordessert<-as.numeric(business_clean$`attributes.Good For.dessert`)
business_clean$goodforlatenight<-as.numeric(business_clean$`attributes.Good For.latenight`)
business_clean$goodforlunch<-as.numeric(business_clean$`attributes.Good For.lunch`)
business_clean$goodfordinner<-as.numeric(business_clean$`attributes.Good For.dinner`)
business_clean$goodforbrunch<-as.numeric(business_clean$`attributes.Good For.brunch`)
business_clean$goodforbreakfast<-as.numeric(business_clean$`attributes.Good For.breakfast`)
business_clean$price<-business_clean$`attributes.Price Range`
business_clean<-business_clean%>%
  mutate(parking=ifelse(`attributes.Parking.garage`==TRUE,1,
                  ifelse(`attributes.Parking.validated`==TRUE,1,
                  ifelse(`attributes.Parking.lot`==TRUE,1,
                  ifelse(`attributes.Parking.valet`==TRUE,1,
                  ifelse(`attributes.Parking.street`==TRUE,2,0))))))%>%
mutate(noise=ifelse(`attributes.Noise Level`=="quiet",0,
               ifelse(`attributes.Noise Level`=="average",1,
              ifelse(`attributes.Noise Level`=="loud",2,3
                ))))%>%
  mutate(alcohol= ifelse(`attributes.Alcohol`=="none",0,1),
                    wifi= ifelse(`attributes.Wi-Fi`=="no",0,
                                        ifelse(`attributes.Wi-Fi`=="free",1,2)))%>%
   select(business_id:stars,zip:wifi)


```

add in type
```{r}
asian<-business_clean%>%filter(grepl("Asian|Chinese|Japanese|Sushi Bars|Indian|Korean|Vietnamese|Thai|Taiwanese|Mongolian|Cantonese|Cambodian|Szechuan|Laotian|Himalayan/Nepalese|Indonesian|Ramen|Teppanyaki|Burmese|Malaysian|Hot Pot|Sri Lankan|International|Oriental|Shanghainese|Curry Sausage|Wok|Fusion|Dim Sum|Filipino|Singaporean|Bangladeshi",categories)) %>% mutate(type="asian")
rest<-business_clean%>%anti_join(asian,by ="business_id")

bars<-rest%>%filter(grepl("Bars|Pubs|Lounges|Irish|Tapas/Small Plates|Wine Bars|Tapas Bars|Cocktail Bars|Gastropubs|Beer Bar|Champagne Bars|Irish Pub|Pub Food|Beer Garden|Beer Gardens|Beer Hall|Nightlife",categories)) %>% mutate(type="bars")
rest<-rest%>%anti_join(bars,by ="business_id")

pizza<-rest%>%filter(grepl("Pizza",categories)) %>% mutate(type="pizza")
rest<-rest%>%anti_join(pizza,by = "business_id")

fastfood<-rest%>%filter(grepl("Burgers|Sandwiches|Fast Food|Hot Dogs|Food Stands|Pita|Street Vendors",categories)) %>% mutate(type="fastfood")
rest<-rest%>%anti_join(fastfood,by ="business_id")

cafe<-rest%>%filter(grepl("Coffee|Tea|Cafes|Bakeries|Desserts|Ice Cream & Frozen Yogurt|Bagels|Donuts|Candy Stores|Chocolatiers & Shops|Cheese Shops|Tea Rooms|Juice Bars & Smoothies|Popcorn Shops|Cupcakes|Pretzels|Fruits & Veggies|Gelato|Coffeeshops|Macarons|Patisserie/Cake Shop|Creperies|Bubble Tea",categories)) %>% mutate(type="cafe")
rest<-rest%>%anti_join(cafe,by = "business_id")


special<-rest%>%filter(grepl("Kosher|Halal",categories)) %>% mutate(type="special")
rest<-rest%>%anti_join(special,by = "business_id")


middle_estern<-rest%>%filter(grepl("Middle Eastern|Persian/Iranian|Armenian|Moroccan|Falafel|Turkish|Afghan|Arabian|Egyptian|Kebab",categories)) %>% mutate(type="middle_estern")
rest<-rest%>%anti_join(middle_estern,by ="business_id")


latin<-rest%>%filter(grepl("Mexican|Colombian|Brazilian|Empanadas|Haitian|Dominican|Puerto Rican|Venezuelan|Cuban|Latin American",categories)) %>% mutate(type="latin")
rest<-rest%>%anti_join(latin,by = "business_id")

african<-rest%>%filter(grepl("Ethiopian|African",categories)) %>% mutate(type="african")
rest<-rest%>%anti_join(african,by = "business_id")


vegetarian<-rest%>%filter(grepl("Vegan|Vegetarian",categories)) %>% mutate(type="vegetarian")
rest<-rest%>%anti_join(vegetarian,by = "business_id")


european<-rest%>%filter(grepl("Mediterranean|Italian|Portuguese|German|Polish|Greek|Ethnic Food|French|Fondue|Spanish|Russian|Belgian|Hungarian|Modern European|Scandinavian|Austrian|Czech|Slovakian|Scottish|Ukrainian|Serbo Croatian|Alsatian|Bavarian|Iberian|Rhinelandian|Eastern European|Swiss Food|Trinidadian",categories)) %>% mutate(type="european")
american<-rest%>%anti_join(european,by = "business_id") %>% mutate(type="american") 

business <- asian %>% rbind(bars) %>% rbind(pizza) %>% rbind(fastfood) %>% rbind(cafe) %>% rbind(special) %>% rbind(middle_estern) %>% rbind(latin) %>% rbind(african) %>% rbind(vegetarian) %>% rbind(european) %>% rbind(american) %>% select(1:2,28,3:27)
```



add in zipcode level demographic data
```{r}
library(readr)
population_zip<-read_csv("population_zipcode_2009-2014.csv")
income_zip<-read_csv("income_zipcode_2009-2014.csv")
education_zip<-read_csv("education_zipcode_2009-2014.csv")
age_zip<-read_csv("age_zipcode_2009-2014.csv")
race_zip<-read_csv("race_zipcode_2009-2014.csv")
landsqmi<-read_csv("zcta2010.csv")
```

demographic data clean
```{r}
##population of each zip code
population_zipdata<-population_zip%>%select(GEO.id2,HD01_VD01)
colnames(population_zipdata)<-c("zip","population_zip")
population_zipdata<-population_zipdata[-1,]

##median income of each zip code
income_zipdata<-income_zip%>%select(GEO.id2,HD01_VD02)
colnames(income_zipdata)<-c("zip","income_zip")
income_zipdata<-income_zipdata[-1,]

##bachelors degree of each zip code
education_zipdata<-education_zip%>%select(GEO.id2,HD01_VD06)
colnames(education_zipdata)<-c("zip","bachelor")
education_zipdata<-education_zipdata[-1,]

##median age of each zip code
age_zipdata<-age_zip%>%select(GEO.id2,HD01_VD02)
colnames(age_zipdata)<-c("zip","age_zip")
age_zipdata<-age_zipdata[-1,]

##race of each zip code
race_zipdata<-race_zip%>%select(GEO.id2,HD01_VD02,HD01_VD03,HD01_VD04,HD01_VD05,HD01_VD06,HD01_VD07)
colnames(race_zipdata)<-c("zip","white","Black or African American","American Indian and Alaska Native","Asian","Native Hawaiian and Other Pacific Islander","other")
race_zipdata<-race_zipdata[-1,]

##combine restaurant and zipcode scale demographic data
business$zip <- as.factor(as.character(business_clean$zip ))
landsqmi$zip <- as.factor(as.character(landsqmi$zip ))
combine<-left_join(business,population_zipdata,by="zip")
combine<-left_join(combine,income_zipdata,by="zip")
combine<-left_join(combine,education_zipdata,by="zip")
combine<-left_join(combine,age_zipdata,by="zip")
combine<-left_join(combine,race_zipdata,by="zip")
combine<-left_join(combine,landsqmi,by="zip")
combine[, 29:38]<- sapply(combine[, 29:38], as.numeric)
combine<-combine%>%
  mutate(popdensity_zip=population_zip/LANDSQMI)%>%
  mutate(education_zip=bachelor/population_zip)%>%
  mutate(white=white/population_zip,
         `Black or African American`=`Black or African American`/population_zip,
         `American Indian and Alaska Native`=`American Indian and Alaska Native`/population_zip,
         Asian=Asian/population_zip,
         `Native Hawaiian and Other Pacific Islander`=`Native Hawaiian and Other Pacific Islander`/population_zip,
         other=other/population_zip)
combine<-combine%>%filter(!is.na(population_zip)&!is.na(income_zip)&!is.na(education_zip)&!is.na(age_zip))%>%select(-bachelor)
data.frame(n.na=sapply(combine, function(x)sum(is.na(x)))) 

combine$state[combine$business_id=="g49oTp73Pk_WpOfQVtmcew"] <- "NV"
restaurant_demo<- data.frame(lapply(combine, as.character), stringsAsFactors=FALSE)
write.csv(restaurant_demo,file="combinewithoutuser_complete.csv", row.names=FALSE)

```
